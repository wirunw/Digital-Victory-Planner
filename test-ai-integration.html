<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Integration Test - Digital Victory Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">AI Integration Test</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test AI Context Awareness</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Test Step</label>
                    <select id="testStep" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="1">Step 1: Setup</option>
                        <option value="2">Step 2: Persona</option>
                        <option value="3">Step 3: Sweet Spot</option>
                        <option value="4">Step 4: Funnel</option>
                        <option value="5">Step 5: Review</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Product Track</label>
                    <select id="testTrack" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Select Track</option>
                        <option value="B2C">B2C - Consumer</option>
                        <option value="B2B">B2B - HCP</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Test Message</label>
                    <textarea id="testMessage" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" 
                        placeholder="Ask AI for suggestions..."></textarea>
                </div>
                
                <button onclick="testAI()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    Test AI Response
                </button>
            </div>
        </div>
        
        <div id="result" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <h3 class="text-lg font-semibold mb-3">AI Response</h3>
            <div id="responseContent" class="bg-gray-50 p-4 rounded-lg"></div>
            <div id="suggestions" class="mt-4 space-y-2"></div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
            <h3 class="font-semibold text-yellow-800 mb-2">Test Checklist:</h3>
            <ul class="text-sm text-yellow-700 space-y-1">
                <li>âœ“ AI responds with context-aware suggestions</li>
                <li>âœ“ Suggestions include field names and recommendations</li>
                <li>âœ“ Accept/Reject buttons work properly</li>
                <li>âœ“ Form fields update when accepting suggestions</li>
                <li>âœ“ Error handling works correctly</li>
            </ul>
        </div>
    </div>

    <script>
        // Icon wrapper
        const Icon = ({ name, className }) => {
            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', name);
            if (className) icon.className = className;
            if (window.lucide) {
                window.lucide.createIcons({ attrs: { class: className }, nameAttr: 'data-lucide' });
            }
            return icon;
        };

        function parseSuggestions(content) {
            const suggestions = [];
            const lines = content.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('ðŸ’¡ **') && line.includes('**:')) {
                    const fieldName = line.match(/\*\*(.*?)\*\*/)?.[1] || '';
                    const suggestion = line.split('**:')[1]?.trim() || '';
                    
                    if (fieldName && suggestion) {
                        suggestions.push({
                            id: Date.now() + Math.random(),
                            fieldName: fieldName,
                            suggestion: suggestion
                        });
                    }
                }
            }
            
            return suggestions;
        }

        async function testAI() {
            const step = document.getElementById('testStep').value;
            const track = document.getElementById('testTrack').value;
            const message = document.getElementById('testMessage').value;
            
            if (!message.trim()) {
                alert('Please enter a test message');
                return;
            }

            // Build context
            const context = {
                step: parseInt(step),
                formData: {
                    productTrack: track,
                    groupName: 'Test Team',
                    productName: 'Test Product',
                    personaName: 'Test Persona',
                    personaPain: 'Test Pain Points'
                }
            };

            let stepSpecificPrompt = '';
            switch(context.step) {
                case 1:
                    stepSpecificPrompt = context.formData.productTrack 
                        ? `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Step 1: Setup à¹à¸¥à¹‰à¸§à¹€à¸¥à¸·à¸­à¸ ${context.formData.productTrack} track à¹à¸¥à¹‰à¸§ à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²à¸«à¸£à¸·à¸­à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ à¹à¸¥à¸°à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸ªà¸™à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸à¸£à¸­à¸à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡à¹„à¸”à¹‰`
                        : `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Step 1: Setup à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸ track à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¸­à¸à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ B2C (Consumer) à¸«à¸£à¸·à¸­ B2B (HCP)`;
                    break;
                case 2:
                    stepSpecificPrompt = `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Step 2: Persona à¸ªà¸³à¸«à¸£à¸±à¸š ${context.formData.productTrack} track à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ persona à¹à¸¥à¸° pain points à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ à¹à¸¥à¸°à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸ªà¸™à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸à¸£à¸­à¸à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡à¹„à¸”à¹‰`;
                    break;
                case 3:
                    stepSpecificPrompt = `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Step 3: Sweet Spot à¸ªà¸³à¸«à¸£à¸±à¸š ${context.formData.productTrack} track à¸Šà¹ˆà¸§à¸¢à¸«à¸²à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆ balance à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ brand message à¸à¸±à¸š audience needs à¹‚à¸”à¸¢à¸„à¸³à¸™à¸¶à¸‡à¸–à¸¶à¸‡ compliance à¹à¸¥à¸°à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸ªà¸™à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸à¸£à¸­à¸à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡à¹„à¸”à¹‰`;
                    break;
                case 4:
                    stepSpecificPrompt = `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Step 4: Funnel à¸ªà¸³à¸«à¸£à¸±à¸š ${context.formData.productTrack} track à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³ activities à¸ªà¸³à¸«à¸£à¸±à¸š TOFU, MOFU, BOFU à¹à¸¥à¸°à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸ªà¸™à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸à¸£à¸­à¸à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡à¹„à¸”à¹‰`;
                    break;
                case 5:
                    stepSpecificPrompt = `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Step 5: Review à¸Šà¹ˆà¸§à¸¢à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸œà¸™à¹à¸¥à¸°à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡`;
                    break;
            }

            const systemPrompt = `à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™ Digital Victory Mentor à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸•à¸¥à¸²à¸”à¸¢à¸²à¹à¸¥à¸°à¸ªà¸¸à¸‚à¸ à¸²à¸ž à¸Šà¹ˆà¸§à¸¢à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²à¹€à¸ à¸ªà¸±à¸Šà¸§à¸²à¸‡à¹à¸œà¸™à¸à¸²à¸£à¸•à¸¥à¸²à¸” ${stepSpecificPrompt} 

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰:
- Team: ${context.formData.groupName}
- Product: ${context.formData.productName} (${context.formData.productTrack || 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸¥à¸·à¸­à¸'})
- Persona: ${context.formData.personaName}
- Pain Points: ${context.formData.personaPain}

**à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸žà¸´à¹€à¸¨à¸©**: à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸™à¸°à¸™à¸³à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸à¸£à¸­à¸à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡ à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸£à¸¹à¸›à¹à¸šà¸š:
ðŸ’¡ **[à¸Šà¸·à¹ˆà¸­à¸Ÿà¸´à¸¥à¸”à¹Œ]**: [à¸„à¸³à¹à¸™à¸°à¸™à¸³]
[Accept] [Reject]

à¸•à¸­à¸šà¸ªà¸±à¹‰à¸™à¹† à¸à¸£à¸°à¸Šà¸±à¸š à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡ à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡`;

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: message }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayResult(data.content);
                
            } catch (error) {
                console.error('Test error:', error);
                displayResult(`Error: ${error.message}`);
            }
        }

        function displayResult(content) {
            const resultDiv = document.getElementById('result');
            const responseContent = document.getElementById('responseContent');
            const suggestionsDiv = document.getElementById('suggestions');
            
            resultDiv.classList.remove('hidden');
            responseContent.textContent = content;
            
            // Parse and display suggestions
            const suggestions = parseSuggestions(content);
            suggestionsDiv.innerHTML = '';
            
            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = '<h4 class="font-semibold mb-2">Parsed Suggestions:</h4>';
                suggestions.forEach(suggestion => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3';
                    suggestionDiv.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-blue-800">${suggestion.fieldName}</div>
                                <p class="text-sm text-gray-700 mt-1">${suggestion.suggestion}</p>
                            </div>
                            <button onclick="acceptSuggestion('${suggestion.fieldName}', '${suggestion.suggestion}')" 
                                class="ml-2 px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                Accept
                            </button>
                        </div>
                    `;
                    suggestionsDiv.appendChild(suggestionDiv);
                });
            }
        }

        function acceptSuggestion(fieldName, suggestion) {
            alert(`Accepted suggestion for ${fieldName}: ${suggestion}`);
            console.log('Accepted:', { fieldName, suggestion });
        }

        // Initialize Lucide icons
        if (window.lucide) {
            window.lucide.createIcons();
        }
    </script>
</body>
</html>
